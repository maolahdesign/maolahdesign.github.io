# 進階函數與資料處理 

### 課程目標

* 掌握資料比對（搜尋/匹配）、陣列運算與動態範圍設定技巧
* 熟悉進階文字處理與清理方法，能處理雜訊型資料
* 學會在不同 Excel 版本（含非 365）下選擇最適合的函數實作
* 了解如何用 ChatGPT 輔助公式生成、錯誤排查與優化

---

### 搜尋與匹配函數

**課程內容：**

* **LOOKUP 函數家族介紹與比較**

  * LOOKUP：線性向量搜尋，簡單但容易出錯
  * VLOOKUP：垂直搜尋（左到右），搜尋欄位必須在範圍最左側
  * HLOOKUP：水平搜尋（上到下），用法與 VLOOKUP 類似
  * INDEX+MATCH：跨欄/跨列更穩健，適合舊版 Excel
  * XLOOKUP（Excel 365 可選）：功能完整，支援反向搜尋、未找到回傳值、精確/近似匹配

* **進階搜尋技巧與注意事項**

  * 精確匹配：VLOOKUP(..., FALSE)
  * 近似匹配：VLOOKUP(..., TRUE) 或省略（需排序）
  * 多條件搜尋（舊版 Excel）：使用 INDEX+MATCH 陣列公式
  * 錯誤處理：搭配 IFERROR 避免 #N/A

**實際範例（非 365 版本）：**

* VLOOKUP（精確匹配）：
  `=VLOOKUP(E2, A:B, 2, FALSE)`
* INDEX + MATCH（跨欄穩健）：
  `=INDEX(B2:B100, MATCH(E2, A2:A100, 0))`
* 多條件查找（舊版需 Ctrl+Shift+Enter）：
  `=INDEX(return_range, MATCH(1, (col1=val1)*(col2=val2), 0))`

**實作練習：**

1. 用 VLOOKUP 與 INDEX+MATCH 對同一筆查詢做比較，觀察欄位順序變動對結果的影響
2. 使用 INDEX+MATCH 完成多條件查找（例如同時比對「員工編號」與「部門」），並用 IFERROR 包裝


好的，我幫你把這兩個實作練習增加 **詳細步驟與操作過程**，方便學生跟著做。下面是整理後的版本：

---

### 實作練習 1：用 VLOOKUP 與 INDEX+MATCH 對同一筆查詢做比較

**目的**：理解 VLOOKUP 受限於查詢欄位置，而 INDEX+MATCH 更靈活。

**步驟**：

1. **準備測試資料**

   | 員工編號 | 部門 | 總銷售  |
   | ---- | -- | ---- |
   | 1001 | 行銷 | 5000 |
   | 1002 | 財務 | 4000 |
   | 1003 | 行銷 | 6000 |

2. **使用 VLOOKUP 查詢**

   * 公式：`=VLOOKUP(1002, A2:C4, 3, FALSE)`
   * 說明：查找員工編號 1002，回傳第 3 欄（總銷售）
   * 結果：4000

3. **使用 INDEX+MATCH 查詢**

   * 公式：`=INDEX(C2:C4, MATCH(1002, A2:A4, 0))`
   * 說明：MATCH 找到 1002 在 A2:A4 的位置，再用 INDEX 回傳 C 欄對應值
   * 結果：4000

4. **觀察欄位順序變動**

   * 將「總銷售」欄移到最左邊
   * 再試一次 VLOOKUP：`=VLOOKUP(1002, A2:C4, 3, FALSE)`

     * 結果可能錯誤，因為 VLOOKUP 只能向右查詢
   * INDEX+MATCH 仍正確：`=INDEX(C2:C4, MATCH(1002, B2:B4, 0))`

**結論**：VLOOKUP 受限於查詢欄在左側；INDEX+MATCH 跨欄穩健，適合欄位順序會變動的情況。

---

### 實作練習 2：使用 INDEX+MATCH 完成多條件查找

**目的**：實作「同時比對員工編號與部門」的查找，並用 IFERROR 避免 #N/A

**步驟**：

1. **準備測試資料**

   | 員工編號 | 部門 | 總銷售  |
   | ---- | -- | ---- |
   | 1001 | 行銷 | 5000 |
   | 1002 | 財務 | 4000 |
   | 1003 | 行銷 | 6000 |
   | 1002 | 行銷 | 3000 |

2. **建立多條件查找公式**

   * 公式（需 Ctrl+Shift+Enter）：

     ```
     =IFERROR(
       INDEX(C2:C5, MATCH(1, (A2:A5=1002)*(B2:B5="行銷"), 0)),
       "無資料"
     )
     ```
   * 說明：

     1. `(A2:A5=1002)` 會生成一個 TRUE/FALSE 陣列
     2. `(B2:B5="行銷")` 也生成 TRUE/FALSE 陣列
     3. 兩個陣列相乘 → 只有同時符合兩條件的位置為 1
     4. MATCH 找到 1 的位置，INDEX 回傳對應總銷售
     5. IFERROR 若找不到，回傳「無資料」

3. **結果驗證**

   * 查找員工編號 1002 且部門「行銷」 → 回傳 3000
   * 查找員工編號 1001 且部門「財務」 → 回傳「無資料」

4. **可擴展操作**

   * 改查其他條件組合
   * 將公式拖拉應用到其他查詢列

**結論**：利用 INDEX+MATCH 搭配陣列，可在舊版 Excel 實現多條件查找，並用 IFERROR 做錯誤處理。

---

### 陣列處理函數

**課程內容：**

* INDEX：擷取指定列/欄值，適合動態欄位取值
* MATCH：回傳查詢值位置，常與 INDEX 搭配
* OFFSET：建立動態範圍（volatile，注意效能）
* SUMPRODUCT：多條件加總 / 計數（不需 Ctrl+Shift+Enter）
* Ctrl+Shift+Enter 陣列公式（舊版 Excel）

**實務範例（舊版 Excel）：**

* 使用 OFFSET 建立動態總和：
  `=SUM(OFFSET($A$2, 0, 0, COUNTA($A:$A)-1, 1))`
* INDEX 建立非 volatile 的動態範圍：
  `=SUM($A$2:INDEX($A:$A, COUNTA($A:$A)))`
* SUMPRODUCT 多條件加總：
  `=SUMPRODUCT((A2:A100="台北")*(C2:C100>1000), C2:C100)`

**實作練習：**

1. 建立自動擴展總和公式，分別用 OFFSET 與 INDEX 比較效能
2. 使用 SUMPRODUCT 完成多條件加總，並驗證與 SUMIFS 結果一致
3. 將 Ctrl+Shift+Enter 的公式改寫成 INDEX+MATCH 或 SUMPRODUCT 版本


明白，我幫你把 **陣列處理與多條件加總的實作練習** 增加完整 **操作步驟、公式示範、結果驗證過程**，方便學生跟著做。

---

### 實作練習 1：建立自動擴展總和公式（OFFSET 與 INDEX 比較效能）

**目的**：理解如何建立「資料新增時自動更新的總和」，並比較 volatile 與非-volatile 函數。

**步驟**：

1. **準備資料**

   | 數值 |
   | -- |
   | 10 |
   | 20 |
   | 30 |

2. **使用 OFFSET 建立動態總和（volatile）**

   * 公式：
     `=SUM(OFFSET($A$2, 0, 0, COUNTA($A:$A)-1, 1))`
   * 說明：

     1. `$A$2`：起始儲存格
     2. `0,0`：列偏移與欄偏移為零
     3. `COUNTA($A:$A)-1`：計算資料列數（扣掉標題）
     4. `1`：寬度 1 列
   * 結果：10 + 20 + 30 = 60

3. **使用 INDEX 建立非 volatile 總和**

   * 公式：
     `=SUM($A$2:INDEX($A:$A, COUNTA($A:$A)))`
   * 說明：

     1. `INDEX($A:$A, COUNTA($A:$A))` 找到最後有資料的儲存格
     2. `SUM($A$2:...)` 從 A2 到最後一列資料總和
   * 結果：同樣為 60

4. **測試資料新增**

   * 在 A5 新增 40
   * OFFSET 公式 → 自動更新為 100
   * INDEX 公式 → 也自動更新為 100

**結論**：INDEX 版本非 volatile，計算效率較高，資料量大時建議使用。

---

### 實作練習 2：使用 SUMPRODUCT 完成多條件加總

**目的**：學會多條件計算，並與 SUMIFS 驗證一致性。

**步驟**：

1. **準備資料**

   | 地區 | 類別 | 銷售額  |
   | -- | -- | ---- |
   | 台北 | A  | 1000 |
   | 台北 | B  | 1500 |
   | 高雄 | A  | 2000 |
   | 台北 | A  | 500  |

2. **使用 SUMPRODUCT 多條件加總**

   * 公式：
     `=SUMPRODUCT((A2:A5="台北")*(B2:B5="A"), C2:C5)`
   * 說明：

     1. `(A2:A5="台北")` → TRUE/FALSE 陣列
     2. `(B2:B5="A")` → TRUE/FALSE 陣列
     3. 相乘 → 同時符合兩條件的列為 1
     4. SUMPRODUCT 將符合列的 C 欄數值加總
   * 結果：1000 + 500 = 1500

3. **使用 SUMIFS 驗證結果**

   * 公式：
     `=SUMIFS(C2:C5, A2:A5, "台北", B2:B5, "A")`
   * 結果：1500
   * 驗證 SUMPRODUCT 與 SUMIFS 一致

---

### 實作練習 3：將 Ctrl+Shift+Enter 的公式改寫成 INDEX+MATCH 或 SUMPRODUCT

**目的**：練習將舊版陣列公式轉為更容易維護或非 volatile 公式。

**步驟**：

1. **準備資料**

   | 員工編號 | 部門 | 銷售額  |
   | ---- | -- | ---- |
   | 1001 | 行銷 | 5000 |
   | 1002 | 財務 | 4000 |
   | 1003 | 行銷 | 6000 |

2. **舊版 Ctrl+Shift+Enter 多條件查找公式**

   * 公式：
     `=INDEX(C2:C4, MATCH(1, (A2:A4=1003)*(B2:B4="行銷"), 0))`
   * 輸入後按 Ctrl+Shift+Enter → 返回 6000

3. **改寫成 SUMPRODUCT（不需 Ctrl+Shift+Enter）**

   * 公式：
     `=SUMPRODUCT((A2:A4=1003)*(B2:B4="行銷")*C2:C4)`
   * 返回結果：6000
   * 說明：SUMPRODUCT 自動處理陣列運算，不需特別輸入陣列公式

4. **測試資料新增**

   * 新增一列 `1003 行銷 2000`
   * SUMPRODUCT → 6000 + 2000 = 8000，自動更新
   * Ctrl+Shift+Enter 公式 → 也更新，效果一致

---

### 文字處理函數

**課程內容：**

* 文字合併：CONCATENATE（舊）、TEXTJOIN（可忽略空白）
* 字串擷取與搜尋：LEN, LEFT, RIGHT, MID, FIND, SEARCH
* 取代與清理：REPLACE, SUBSTITUTE, TRIM, CLEAN
* 轉換大小寫：UPPER, LOWER, PROPER
* 高級功能（僅 Excel 365 / Power Query）：TEXTSPLIT, FILTERXML

**實際範例（舊版 Excel 可用）：**

* 合併多欄（忽略空白）：
  `=A2 & " " & B2`（舊版）
* 移除文字特殊符號並轉數值：
  `=VALUE(SUBSTITUTE(A2, "$", ""))`
* 擷取固定格式中的一段（ID-YYYYMMDD-XXX）：
  `=MID(A2, FIND("-", A2)+1, 8)`

**實作練習：**

1. 合併「姓」與「名」成「姓名」，並示範 LEFT/RIGHT 拆解
2. 清理貨幣符號、千分位、空白，轉為純數字
3. 用 CONCATENATE 或 TEXTJOIN 建立聯絡資訊欄（手機、分機、Email）

明白，我幫你把這三個文字處理的實作練習，增加 **詳細操作步驟與公式示範**，適合舊版 Excel 也能操作。

---

### 實作練習 1：合併「姓」與「名」成「姓名」

**目的**：學會將兩欄文字合併，以及如何拆解姓名。

**步驟**：

1. **準備資料**

   | 姓 | 名  |
   | - | -- |
   | 王 | 小明 |
   | 李 | 小華 |
   | 張 | 大強 |

2. **合併姓與名**

   * 公式（舊版 Excel）：
     `=A2 & B2` → 結果：王小明
   * 若要加空格：
     `=A2 & " " & B2` → 結果：王 小明

3. **拆解姓名（LEFT/RIGHT）**

   * 取姓：`=LEFT(C2, 1)` → 結果：王
   * 取名：`=RIGHT(C2, LEN(C2)-1)` → 結果：小明

4. **進階練習**

   * 若姓有兩個字（如「歐陽」），則公式需調整：

     * `=LEFT(C2, LEN(C2)-1)` 取姓
     * `=RIGHT(C2, 1)` 取名

---

### 實作練習 2：清理貨幣符號、千分位、空白，轉為純數字

**目的**：將含 `$`、逗號、空白的文字轉為數字，以便計算。

**步驟**：

1. **準備資料**

   | 銷售額     |
   | ------- |
   | $5,000  |
   | $4,200  |
   | $ 3,600 |

2. **移除符號與空白**

   * 公式：
     `=VALUE(SUBSTITUTE(SUBSTITUTE(A2, "$", ""), ",", ""))`

     * `SUBSTITUTE(A2, "$", "")` → 去掉 `$`
     * `SUBSTITUTE(..., ",", "")` → 去掉千分位逗號
     * `VALUE(...)` → 將文字轉成數字

3. **結果**

   | 原始資料    | 清理後數值 |
   | ------- | ----- |
   | $5,000  | 5000  |
   | $4,200  | 4200  |
   | $ 3,600 | 3600  |

---

### 實作練習 3：用 CONCATENATE 或 TEXTJOIN 建立聯絡資訊欄

**目的**：將多個欄位組合成一欄顯示，並可忽略空白欄位。

**步驟**：

1. **準備資料**

   | 手機         | 分機  | Email                               |
   | ---------- | --- | ----------------------------------- |
   | 0912345678 | 123 | [abc@mail.com](mailto:abc@mail.com) |
   | 0987654321 |     | [xyz@mail.com](mailto:xyz@mail.com) |
   | 0922333444 | 456 |                                     |

2. **合併聯絡資訊（CONCATENATE）**

   * 公式：
     `=CONCATENATE(A2, " / ", B2, " / ", C2)`
   * 結果可能出現空白欄位仍有分隔符

3. **合併聯絡資訊（TEXTJOIN，舊版 Excel 可用 IF 判斷忽略空白）**

   * 公式示例（忽略空白）：

     ```
     =A2 & IF(B2<>"", " / "&B2, "") & IF(C2<>"", " / "&C2, "")
     ```
   * 結果：

     | 合併欄位                                                   |
     | ------------------------------------------------------ |
     | 0912345678 / 123 / [abc@mail.com](mailto:abc@mail.com) |
     | 0987654321 / [xyz@mail.com](mailto:xyz@mail.com)       |
     | 0922333444 / 456                                       |

---

### 使用 ChatGPT 進行函數公式解讀與生成

**課程內容：**

* 撰寫有效 Prompt：提供資料欄位說明、範例資料、期望輸出、Excel 版本（是否支援 XLOOKUP / 動態陣列）
* 常見請求類型：產生公式、改寫公式（如 VLOOKUP→INDEX+MATCH）、診斷除錯
* 驗證與最佳實務：測試邊界條件，避免過度使用 volatile 函數

**範例 Prompt（非 365 版本）：**

> 我有一個表格（A欄 員工編號, B欄 部門, C欄 總銷售）。請幫我寫公式：
> 當 A2 的員工編號存在且 B2 為 "行銷" 時，回傳該員工在 C 欄的銷售數；否則回傳 "無資料"。我的 Excel 版本不支援 XLOOKUP。

* ChatGPT 可回傳公式（INDEX+MATCH 版本）：
  `=IF(B2="行銷", IFERROR(INDEX(C:C, MATCH(A2, A:A, 0)), "無資料"), "無資料")`

**實作練習：**

1. 交給 ChatGPT 自然語言需求，取得 INDEX+MATCH 版本，套用測試
2. 貼上有問題的公式，讓 ChatGPT 協助除錯
3. 優化公式效能，將 volatile 函數改為非 volatile 寫法


明白，我幫你把 **ChatGPT 實作練習**的三個步驟增加完整 **操作過程與示範**，適合舊版 Excel 也能跟著做。

---

### 實作練習（使用 ChatGPT 輔助公式生成與優化）

---

#### **步驟 1：交給 ChatGPT 自然語言需求，取得 INDEX+MATCH 版本並套用測試**

**目標**：將日常需求轉成可用公式。

**操作過程**：

1. **準備資料**

| 員工編號 | 部門 | 銷售額  |
| ---- | -- | ---- |
| 1001 | 行銷 | 5000 |
| 1002 | 財務 | 4000 |
| 1003 | 行銷 | 6000 |

2. **提出需求給 ChatGPT**

   ```
   我有表格 A欄:員工編號, B欄:部門, C欄:銷售額。
   請幫我寫公式：當 A2 的員工編號存在，且 B2 為 "行銷" 時，回傳該員工 C 欄銷售額，否則回傳 "無資料"。
   我的 Excel 不支援 XLOOKUP。
   ```

3. **ChatGPT 回傳公式（INDEX+MATCH 版本）**

   ```
   =IF(B2="行銷", IFERROR(INDEX(C:C, MATCH(A2, A:A, 0)), "無資料"), "無資料")
   ```

4. **套用公式測試**

   * 輸入 A2=1003, B2="行銷" → 結果：6000
   * 輸入 A2=1002, B2="行銷" → 結果："無資料"

---

#### **步驟 2：貼上有問題的公式，讓 ChatGPT 協助除錯**

**目標**：學會排錯，避免公式錯誤。

**操作過程**：

1. 假設輸入的公式：

   ```
   =IF(B2="行銷", INDEX(C:C, MATCH(A2, B:B, 0)), "無資料")
   ```

   * 錯誤原因：MATCH 查找範圍使用 B:B，而應該是 A:A（員工編號所在欄）

2. 將公式貼給 ChatGPT，說明錯誤現象：

   ```
   我的公式總是 #N/A，請幫我找錯。
   ```

3. ChatGPT 回傳修正建議：

   ```
   MATCH 範圍應為 A:A，改公式為：
   =IF(B2="行銷", IFERROR(INDEX(C:C, MATCH(A2, A:A, 0)), "無資料"), "無資料")
   ```

4. **驗證**

   * 輸入 A2=1002, B2="財務" → 結果："無資料"
   * 輸入 A2=1001, B2="行銷" → 結果：5000

---

#### **步驟 3：優化公式效能，將 volatile 函數改為非 volatile 寫法**

**目標**：避免 OFFSET、INDIRECT 等 volatile 函數影響效能。

**操作過程**：

1. 假設原始公式（使用 OFFSET）：

   ```
   =SUM(OFFSET(C2, 0, 0, COUNTA(A:A)-1, 1))
   ```

   * 問題：OFFSET 為 volatile，資料量大時計算慢

2. 將公式改為 INDEX 版本（非 volatile）：

   ```
   =SUM(C2:INDEX(C:C, COUNTA(C:C)))
   ```

   * 說明：INDEX 找到最後一列有資料的儲存格，範圍自動擴展
   * 運算效率高，不會因 Excel 重算而頻繁觸發

3. **驗證結果**

   * 原始資料：C2:C4 = 5000, 4000, 6000 → SUM = 15000
   * 新增 C5=2000 → SUM 自動更新為 17000
---

## 函數總整理表格（非 365 版本）

| 函式名稱                   | 用途               | 使用語法或備註                       |
| ---------------------- | ---------------- | ----------------------------- |
| LOOKUP                 | 簡易搜尋             | LOOKUP(查詢值, 查詢向量, [結果向量])     |
| VLOOKUP                | 垂直搜尋             | VLOOKUP(查詢值, 範圍, 欄號, [精確/近似]) |
| HLOOKUP                | 水平搜尋             | HLOOKUP(查詢值, 範圍, 列號, [精確/近似]) |
| INDEX                  | 陣列索引             | INDEX(範圍, 列號, [欄號])           |
| MATCH                  | 回傳位置             | MATCH(查詢值, 查詢範圍, 比對類型)        |
| OFFSET                 | 建立動態範圍（volatile） | OFFSET(起始, 列偏移, 欄偏移, 高度, 寬度)  |
| SUMPRODUCT             | 多條件計算            | 可作加總或計數（不需 Ctrl+Shift+Enter）  |
| CONCATENATE / TEXTJOIN | 串接字串             | TEXTJOIN(分隔符, 忽略空白, 範圍1, ...) |
| SUBSTITUTE             | 取代字串             | SUBSTITUTE(原字串, 舊, 新, [第幾個])  |

> XLOOKUP / FILTER / UNIQUE 僅作 Excel 365 可選補充

---

## 實作總練習（整章應用，舊版 Excel 皆可操作）

1. 準備資料：員工編號、部門、日期、銷售、備註（含空白、$, 千分位），完成資料清理（去特殊字元、轉數值、去空白）
2. 實作多種查找方法：VLOOKUP / INDEX+MATCH，比較結果與效能
3. 用陣列公式或 SUMPRODUCT 做月份條件銷售加總，並建立動態報表
4. 使用 ChatGPT 生成公式完成查找或彙總，並記錄多種解法與測試結果

---